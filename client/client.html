<!DOCTYPE html>
<html lang="en">
<head>
  <title>Project 1</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script>
    // Used in-class examples as references and borrowed code:
    /// https://github.com/IGM-RichMedia-at-RIT/body-parse-example-done/blob/master
    /// https://github.com/IGM-RichMedia-at-RIT/head-request-example-done/blob/master

    // Parse responses from API once received
    const handleResponse = async (response, parseResponse) => {
      
      const rawContent = document.querySelector('#rawContent');
      rawContent.innerHTML = '';
      const cleanContent = document.querySelector('#cleanContent');
      cleanContent.innerHTML = '';

      // Show Result & Status Code
      switch(response.status) {
        case 200: 
          rawContent.innerHTML = `<b>200: Success</b>`;
          break;
        case 201:
          rawContent.innerHTML = `<b>201: Created</b>`;
          break;
        case 204:
          rawContent.innerHTML = `<b>204:Updated</b>`;
          break;
        case 400: 
          rawContent.innerHTML = `<b>400: Bad Request</b>`;
          break;
        case 404:
          rawContent.innerHTML = `<b>404: Resource Not Found</b>`;
          break;
        default: 
          rawContent.innerHTML = `Error code not implemented by client.`;
          break;
      }

      // Make the incoming data look "pretty"
      if(parseResponse) {
        let obj = await response.json();

        let jsonString = JSON.stringify(obj);
        rawContent.innerHTML += `<p>${jsonString}</p>`;

        if(obj.results != null)
        {
          if(obj.results.length > 1)
          {
            obj.results.forEach(element => {
              cleanContent.innerHTML += `<p>${element.name}</p>`;
            });
          }
          else if (obj.results.length === 1)
          {
            cleanContent.innerHTML += `<p><i>Card Name:</i> ${obj.results[0].name}</p>`;
            cleanContent.innerHTML += `<p><i>Cost:</i> ${obj.results[0].manaCost}</p>`;
            cleanContent.innerHTML += `<p><i>Type:</i> ${obj.results[0].type}</p>`;
            cleanContent.innerHTML += `<p><i>Text:</i> ${obj.results[0].text}</p>`;
            cleanContent.innerHTML += `<p><i>Rarity:</i> ${obj.results[0].rarity}</p>`;
            cleanContent.innerHTML += `<p><i>Artist:</i> ${obj.results[0].artist}</p>`;
          }
        }
        else if (obj.tokenData != null)
        {
          console.log(obj.tokenData);
          obj.tokenData.forEach(element => {
            cleanContent.innerHTML += `<p><i>Name:</i> ${element.name}</p>`;
            cleanContent.innerHTML += `<p><i>Description:</i> ${element.description}</p><br>`;
          });
        }
      } else {
        rawContent.innerHTML += '<p>Meta Data Received</p>';
      }
    };

    // Sends a GET request to given URL
    const requestUpdate = async (userForm) => {
      const url = userForm.querySelector('#urlField').value;
      const method = userForm.querySelector('#methodSelect').value;
      
      let response = await fetch(url, {
        method,
        headers: {
            'Accept': 'application/json'
        },
      });
      handleResponse(response, method === 'get');
    };

    // Variant of requestUpdate specially suited for getCard calls due to extra parameters
    const requestCardSearch = async (userForm) => {
      const method = userForm.querySelector('#methodSelect').value;

      let url = userForm.querySelector('#urlField').value + '?';

      console.log(userForm);

      if(userForm.querySelector('#cardName').value) { 
        url += '&name=' + userForm.querySelector('#cardName').value;
      }
      if(userForm.querySelector('#cardCMC').value) { 
        url += '&cmc=' + userForm.querySelector('#cardCMC').value;
      }
      if(userForm.querySelector('#cardColor').value) { 
        url += '&color=' + userForm.querySelector('#cardColor').value;
      }
      if(userForm.querySelector('#cardRarity').value) { 
        url += '&rarity=' + userForm.querySelector('#cardRarity').value;
      }
      if(userForm.querySelector('#cardType').value) { 
        url += '&type=' + userForm.querySelector('#cardType').value;
      }
      if(userForm.querySelector('#cardArtist').value) { 
        url += '&artist=' + userForm.querySelector('#cardArtist').value;
      }
      
      let response = await fetch(url, {
        method,
        headers: {
            'Accept': 'application/json'
        },
      });
      handleResponse(response, method === 'get');
    };

    // Sends POST request to given URL
    const sendPost = async (nameForm) => {
      const url = nameForm.getAttribute('action');
      const method = nameForm.getAttribute('method');
      
      let formData = `name=${nameForm.querySelector('#nameField').value}`;

      if(nameForm.querySelector('#descriptionField')) {
        formData += `&description=${nameForm.querySelector('#descriptionField').value}`;
      }

      let object = {
        method: method,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        body: formData,
      }

      let response = await fetch(url, object);

      handleResponse(response, true);
    };

    // Attaches function calls to correct buttons
    const init = () => {

      const simpleGetForm = document.querySelector('#simpleGetForm');
      const getData = (e) => {
        e.preventDefault();
        requestUpdate(simpleGetForm);
        return false;
      }
      simpleGetForm.addEventListener('submit', getData);

      const cardSearchForm = document.querySelector('#cardSearchForm');
      const getCard = (e) => {
        e.preventDefault();
        requestCardSearch(cardSearchForm);
        return false;
      }
      cardSearchForm.addEventListener('submit', getCard);

      const collectionForm = document.querySelector('#collectionForm');
      const addToCollection = (e) => {
        e.preventDefault();
        sendPost(collectionForm);
        return false;
      }
      collectionForm.addEventListener('submit', addToCollection);

      const tokenForm = document.querySelector('#tokenForm');
      const addToTokens = (e) => {
        e.preventDefault();
        sendPost(tokenForm);
        return false;
      }
      tokenForm.addEventListener('submit', addToTokens);

      const setForm = document.querySelector('#setForm');
      const switchSet = (e) => {
        e.preventDefault();
        sendPost(setForm);
        return false;
      }
      setForm.addEventListener('submit', switchSet);
    };

    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h1>MTG Old School Collection Tracker</h1>
     <a href="/documentation"><button type="button">Documentation</button></a>
    <hr>
    <h2>GET/HEAD Requests:</h2>

    <br>

    <h3>Basic Requests</h3>
      <form id="simpleGetForm" method="GET">
        <select id='urlField'>
          <option value='/getRawData'>Get RAW Set Data</option>
          <option value='/getRandomCard'>Get Random Card</option>
          <option value='/getCollectionData'>Get Set Collection</option>
          <option value='/getTokenData'>Get Token Collection</option>
          <option value='/fakeRequest'>Make an Invalid Request</option>
        </select>
        <select id="methodSelect">
          <option value="get">GET</option>
          <option value="head">HEAD</option>
        </select>
        <input type="submit" value="Send" />
      </form>

      <br>

      <h3>Card Search</h3>
      <form id="cardSearchForm" method="GET">
        <select id='urlField'>
          <option value='/getCard'>Search for Card</option>
          <option value='/fakeRequest'>Make an Invalid Request</option>
        </select>
        <select id="methodSelect">
          <option value="get">GET</option>
          <option value="head">HEAD</option>
        </select>
        <label for="cardName">Card Name:</label>
        <input type="text" id="cardName" name="cardName">
        <label for="cardArtist">Artist:</label>
        <input type="text" id="cardArtist" name="cardArtist">
        <label for="cardCMC">Mana Cost:</label>
        <input type="number" id="cardCMC" name="cardCMC" min="0" max="10">
        <label for="cardColor">Color:</label>
        <select id="cardColor" name="cardColor">
          <option value=""> </option>
          <option value="W">White</option>
          <option value="U">Blue</option>
          <option value="B">Black</option>
          <option value="R">Red</option>
          <option value="G">Green</option>
          <option value="C">Colorless</option>
        </select>
        <label for="cardType">Type:</label>
        <select id="cardType" name="cardType">
          <option value=""> </option>
          <option value="creature">Creature</option>
          <option value="sorcery">Sorcery</option>
          <option value="instant">Instant</option>
          <option value="enchantment">Enchantment</option>
          <option value="artifact">Artifact</option>
          <option value="land">Land</option>
        </select>
        <label for="cardRarity">Rarity:</label>
        <select id="cardRarity" name="cardRarity">
          <option value=""> </option>
          <option value="common">Common</option>
          <option value="uncommon">Uncommon</option>
          <option value="rare">Rare</option>
        </select>
        <input type="submit" value="Send" />
      </form>

    <br>

    <hr>

    <h2> POST Requests</h2>

    <br>

    <h3>Modify Card Collection</h3>
      <form id="collectionForm" action="/addCardToCollection" method="POST">
        <label for="name">Card Name: </label>
        <input id="nameField" type="text" name="name" />
        <input id="addToCollectionButton" type="submit" value="Add to/Remove from Collection" />
      </form>

      <br>

      <h3>Add to Token Collection</h3>
      <form id="tokenForm" action="/addTokenToCollection" method="POST">
        <label for="name">Token Name: </label>
        <input id="nameField" type="text" name="name" />
        <label for="description">Token Description: </label>
        <input id="descriptionField" type="text" name="description" />
        <input id="addToTokensButton" type="submit" value="Add To Collection" />
      </form>

      <br>

      <h3>Switch Current Set</h3>
      <form id="setForm" action="/switchSet" method="POST">
        <label for="name">Select Set:</label>
        <select id="nameField" name="name">
          <option value="LEA">Alpha</option>
          <option value="LEB">Beta</option>
          <option value="2ED">Unlimited</option>
          <option value="ARN">Arabian Nights</option>
          <option value="ATQ">Antiquities</option>
          <option value="LEG">Legends</option>
          <option value="DRK">The Dark</option>
          <option value="FEM">Fallen Empires</option>
          <option value="FAKE">Fake Set</option>
        </select>
        <input id="switchSetsButton" type="submit" value="Switch Set" />
      </form>

      <br>

    <hr>

  </section>
  
  <section id="content">
    <h2>Card(s) Returned</h2>
    <section id="cleanContent">

    </section>

    <hr>

    <h2>Raw Data</h2>
    <section id="rawContent">

    </section>
  </section>
</body>
</html>